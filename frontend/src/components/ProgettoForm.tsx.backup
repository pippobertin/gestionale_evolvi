'use client'

import { useState, useEffect } from 'react'
import {
  X,
  Save,
  Calendar,
  Building2,
  Euro,
  User,
  FileText,
  Clock,
  AlertTriangle,
  CheckCircle,
  Upload,
  Eye,
  Trash2,
  Download,
  AlertCircle
} from 'lucide-react'
import { supabase } from '@/lib/supabase'
import Docxtemplater from 'docxtemplater'
import PizZip from 'pizzip'
import * as mammoth from 'mammoth'
import { Document, Packer, Paragraph, TextRun } from 'docx'
import { createReport } from 'docx-templates'

interface ProgettoFormData {
  bando_id: string
  cliente_id: string
  codice_progetto: string
  titolo_progetto: string
  descrizione_progetto: string
  stato: 'DECRETO_ATTESO' | 'DECRETO_RICEVUTO' | 'ACCETTATO' | 'IN_CORSO' | 'COMPLETATO'
  importo_totale_progetto: number
  contributo_ammesso: number
  percentuale_contributo: number
  data_pubblicazione_graduatoria: string
  data_decreto_concessione: string
  scadenza_accettazione_esiti: string
  data_avvio_progetto: string
  data_fine_progetto_prevista: string
  anticipo_richiedibile: boolean
  percentuale_anticipo: number
  numero_sal: 'UNICO' | 'DUE' | 'TRE'
  proroga_richiedibile: boolean
  referente_interno: string
  email_referente_interno: string
  note_progetto: string
}

interface Bando {
  id: string
  nome: string
  codice_bando: string
  contributo_massimo: number
  percentuale_contributo: number
  tipologia_bando: string
}

interface Cliente {
  id: string
  denominazione: string
  partita_iva: string
  codice_fiscale: string
}

interface ProgettoFormProps {
  onClose: () => void
  onProgettoCreated: () => void
  bando?: Bando
  cliente?: Cliente
  progetto?: any // Per modifica esistente
}

type TabType = 'generale' | 'importi' | 'scadenze' | 'documenti' | 'avanzate'

export default function ProgettoForm({ onClose, onProgettoCreated, bando, cliente, progetto }: ProgettoFormProps) {
  const [activeTab, setActiveTab] = useState<TabType>('generale')
  const [loading, setLoading] = useState(false)
  const [bandi, setBandi] = useState<Bando[]>([])
  const [clienti, setClienti] = useState<Cliente[]>([])
  const [templateScadenze, setTemplateScadenze] = useState<any[]>([])
  const [bandoSelezionato, setBandoSelezionato] = useState<any>(null)

  // Stati per documenti
  const [documenti, setDocumenti] = useState<any[]>([])
  const [documentiEreditati, setDocumentiEreditati] = useState<any[]>([])
  const [uploading, setUploading] = useState(false)
  const [uploadProgress, setUploadProgress] = useState<{[key: string]: number}>({})

  const [formData, setFormData] = useState<ProgettoFormData>({
    bando_id: bando?.id || '',
    cliente_id: cliente?.id || '',
    codice_progetto: '',
    titolo_progetto: '',
    descrizione_progetto: '',
    stato: 'DECRETO_ATTESO',
    importo_totale_progetto: 0,
    contributo_ammesso: 0,
    percentuale_contributo: bando?.percentuale_contributo || 0,
    data_pubblicazione_graduatoria: '',
    data_decreto_concessione: '',
    scadenza_accettazione_esiti: '',
    data_avvio_progetto: '',
    data_fine_progetto_prevista: '',
    anticipo_richiedibile: true,
    percentuale_anticipo: 30,
    numero_sal: 'DUE',
    proroga_richiedibile: true,
    referente_interno: '',
    email_referente_interno: '',
    note_progetto: ''
  })

  useEffect(() => {
    loadBandi()
    loadClienti()

    if (progetto) {
      // Modifica progetto esistente - pre-popola tutti i campi
      setFormData({
        bando_id: progetto.bando_id || '',
        cliente_id: progetto.cliente_id || '',
        codice_progetto: progetto.codice_progetto || '',
        titolo_progetto: progetto.titolo_progetto || '',
        descrizione_progetto: progetto.descrizione_progetto || '',
        stato: progetto.stato || 'DECRETO_ATTESO',
        importo_totale_progetto: progetto.importo_totale_progetto || 0,
        contributo_ammesso: progetto.contributo_ammesso || 0,
        percentuale_contributo: progetto.percentuale_contributo || 0,
        data_pubblicazione_graduatoria: progetto.data_pubblicazione_graduatoria ? progetto.data_pubblicazione_graduatoria.split('T')[0] : '',
        data_decreto_concessione: progetto.data_decreto_concessione ? progetto.data_decreto_concessione.split('T')[0] : '',
        scadenza_accettazione_esiti: progetto.scadenza_accettazione_esiti ? progetto.scadenza_accettazione_esiti.split('T')[0] : '',
        data_avvio_progetto: progetto.data_avvio_progetto ? progetto.data_avvio_progetto.split('T')[0] : '',
        data_fine_progetto_prevista: progetto.data_fine_progetto_prevista ? progetto.data_fine_progetto_prevista.split('T')[0] : '',
        anticipo_richiedibile: progetto.anticipo_richiedibile || true,
        percentuale_anticipo: progetto.percentuale_anticipo || 30,
        numero_sal: progetto.numero_sal || 'DUE',
        proroga_richiedibile: progetto.proroga_richiedibile !== false,
        referente_interno: progetto.referente_interno || '',
        email_referente_interno: progetto.email_referente_interno || '',
        note_progetto: progetto.note_progetto || ''
      })

      // Carica documenti per progetto esistente
      loadDocumenti(progetto.id)
    } else {
      // Nuovo progetto
      generateCodiceProgetto()

      // Se passato un bando, pre-popola i campi
      if (bando) {
        console.log('üìã Bando pre-selezionato trovato:', {
          id: bando.id,
          nome: bando.nome,
          data_pubblicazione_graduatoria: bando.data_pubblicazione_graduatoria
        })

        const dataEreditata = bando.data_pubblicazione_graduatoria ?
          bando.data_pubblicazione_graduatoria.split('T')[0] : ''

        console.log('üìÖ Ereditando data dal bando pre-selezionato:', dataEreditata)

        setFormData(prev => ({
          ...prev,
          contributo_ammesso: bando.contributo_massimo,
          percentuale_contributo: bando.percentuale_contributo,
          // Importa automaticamente la data pubblicazione graduatoria
          data_pubblicazione_graduatoria: dataEreditata
        }))
      }
    }
  }, [bando, progetto])

  // Funzione per aggiornare il titolo progetto
  const updateTitoloProgetto = () => {
    const selectedBando = bando || bandi.find(b => b.id === formData.bando_id)
    const selectedCliente = cliente || clienti.find(c => c.id === formData.cliente_id)

    if (selectedBando) {
      let nuovoTitolo = `Progetto ${selectedBando.nome}`
      if (selectedCliente) {
        nuovoTitolo += ` ${selectedCliente.denominazione}`
      }
      setFormData(prev => ({ ...prev, titolo_progetto: nuovoTitolo }))
    }
  }

  // Aggiorna il titolo quando cambiano bando o cliente
  useEffect(() => {
    updateTitoloProgetto()
  }, [formData.bando_id, formData.cliente_id, bandi, clienti])

  // Carica template scadenze quando cambia il bando selezionato
  useEffect(() => {
    if (formData.bando_id) {
      console.log('üîÑ Loading bando con template per:', formData.bando_id)
      loadBandoConTemplate(formData.bando_id)
    }
  }, [formData.bando_id])

  // Carica anche il bando pre-selezionato se passato come prop
  useEffect(() => {
    if (bando && bando.id && !bandoSelezionato) {
      console.log('üîÑ Loading bando pre-selezionato:', bando.id, bando.nome)
      loadBandoConTemplate(bando.id)
    }
  }, [bando, bandoSelezionato])

  const loadBandi = async () => {
    try {
      const { data, error } = await supabase
        .from('scadenze_bandi_bandi')
        .select('id, nome, codice_bando, contributo_massimo, percentuale_contributo, tipologia_bando, data_pubblicazione_graduatoria')
        .order('nome')

      if (error) throw error
      setBandi(data || [])
    } catch (error) {
      console.error('Errore caricamento bandi:', error)
    }
  }

  const loadBandoConTemplate = async (bandoId: string) => {
    try {
      console.log('üìã Caricando dati completi per bando:', bandoId)

      // Carica bando con tutti i dati necessari
      const { data: bandoData, error: bandoError } = await supabase
        .from('scadenze_bandi_bandi')
        .select('id, nome, data_pubblicazione_graduatoria, contributo_massimo, percentuale_contributo')
        .eq('id', bandoId)
        .single()

      if (bandoError) {
        console.error('Errore caricamento bando:', bandoError)
        throw bandoError
      }

      console.log('üìã Dati bando caricati:', bandoData)
      setBandoSelezionato(bandoData)

      // Se il bando ha una data_pubblicazione_graduatoria e il form non l'ha ancora, ereditala
      if (bandoData.data_pubblicazione_graduatoria && !formData.data_pubblicazione_graduatoria) {
        console.log('üìÖ Ereditando data pubblicazione graduatoria dal bando:', bandoData.data_pubblicazione_graduatoria)
        setFormData(prev => ({
          ...prev,
          data_pubblicazione_graduatoria: bandoData.data_pubblicazione_graduatoria.split('T')[0]
        }))
      }

      // Carica template scadenze del bando
      const { data: templates, error: templatesError } = await supabase
        .from('scadenze_bandi_template_scadenze')
        .select('*')
        .eq('bando_id', bandoId)
        .order('ordine_sequenza')

      if (templatesError) {
        console.error('Errore caricamento template (non bloccante):', templatesError)
        // Non lanciamo l'errore perch√© i template potrebbero non esistere
      }

      console.log('üìã Template scadenze caricati:', templates?.length || 0, 'template')
      console.log('üìã Template completi:', templates)
      setTemplateScadenze(templates || [])
    } catch (error) {
      console.error('Errore caricamento bando e template:', error)
    }
  }

  // Calcola scadenze in anteprima basandosi sui template e date inserite
  const calcolaScadenzeAnteprima = () => {
    if (!bandoSelezionato || !templateScadenze || templateScadenze.length === 0) return []

    // Sistema universale basato sui template del bando
    const scadenzeCalcolate = []

    for (const template of templateScadenze) {
      let dataRiferimento = null
      let eventoNome = ''

      // Determina la data di riferimento
      if (template.evento_riferimento === 'pubblicazione_graduatoria') {
        dataRiferimento = formData.data_pubblicazione_graduatoria || bandoSelezionato.data_pubblicazione_graduatoria
        eventoNome = 'Pubblicazione Graduatoria'
      } else if (template.evento_riferimento === 'decreto_concessione') {
        dataRiferimento = formData.data_decreto_concessione
        eventoNome = 'Decreto Concessione'
      } else if (template.evento_riferimento === 'avvio_progetto') {
        dataRiferimento = formData.data_avvio_progetto
        eventoNome = 'Avvio Progetto'
      }

      // Se non abbiamo la data specifica, usa pubblicazione graduatoria come fallback
      if (!dataRiferimento) {
        dataRiferimento = formData.data_pubblicazione_graduatoria || bandoSelezionato.data_pubblicazione_graduatoria
        eventoNome = 'Pubblicazione Graduatoria (fallback)'
      }

      if (dataRiferimento) {
        const dataRif = new Date(dataRiferimento)
        const dataScadenza = new Date(dataRif)
        dataScadenza.setDate(dataScadenza.getDate() + (template.giorni_da_evento || 0))

        scadenzeCalcolate.push({
          nome: template.nome || template.nome_scadenza,
          dataScadenza: dataScadenza.toLocaleDateString('it-IT'),
          calcolabile: true,
          priorita: template.priorita || 'media',
          giorni_da_evento: `+${template.giorni_da_evento || 0}`,
          evento_riferimento: eventoNome,
          dataRiferimentoUsata: dataRif.toLocaleDateString('it-IT')
        })
      } else {
        scadenzeCalcolate.push({
          nome: template.nome || template.nome_scadenza,
          dataScadenza: '',
          calcolabile: false,
          priorita: template.priorita || 'media',
          giorni_da_evento: `+${template.giorni_da_evento || 0}`,
          evento_riferimento: template.evento_riferimento || 'N/D',
          dataRiferimentoUsata: ''
        })
      }
    }

    return scadenzeCalcolate
  }

  const loadClienti = async () => {
    try {
      const { data, error } = await supabase
        .from('scadenze_bandi_clienti')
        .select('id, denominazione, partita_iva, codice_fiscale')
        .order('denominazione')

      if (error) throw error
      setClienti(data || [])
    } catch (error) {
      console.error('Errore caricamento clienti:', error)
    }
  }

  const generateCodiceProgetto = async () => {
    try {
      const { data, error } = await supabase
        .from('scadenze_bandi_progetti')
        .select('codice_progetto')
        .order('created_at', { ascending: false })
        .limit(1)

      if (error) throw error

      let nuovoNumero = 1
      if (data && data.length > 0) {
        const ultimoCodice = data[0].codice_progetto
        const match = ultimoCodice?.match(/PRJ-(\d{4})-(\d{3})/)
        if (match) {
          const anno = new Date().getFullYear()
          const ultimoAnno = parseInt(match[1])
          const ultimoNumero = parseInt(match[2])

          if (ultimoAnno === anno) {
            nuovoNumero = ultimoNumero + 1
          } else {
            nuovoNumero = 1
          }
        }
      }

      const anno = new Date().getFullYear()
      const numeroFormattato = nuovoNumero.toString().padStart(3, '0')
      const nuovoCodice = `PRJ-${anno}-${numeroFormattato}`

      setFormData(prev => ({ ...prev, codice_progetto: nuovoCodice }))
    } catch (error) {
      console.error('Errore generazione codice:', error)
      const anno = new Date().getFullYear()
      const fallbackCodice = `PRJ-${anno}-001`
      setFormData(prev => ({ ...prev, codice_progetto: fallbackCodice }))
    }
  }

  const handleBandoChange = (bandoId: string) => {
    const selectedBando = bandi.find(b => b.id === bandoId)
    console.log('DEBUG - handleBandoChange:', {
      bandoId,
      selectedBando,
      data_pubblicazione_graduatoria: selectedBando?.data_pubblicazione_graduatoria
    })

    if (selectedBando) {
      const dataEredirata = selectedBando.data_pubblicazione_graduatoria ?
        selectedBando.data_pubblicazione_graduatoria.split('T')[0] : ''

      console.log('DEBUG - Ereditando data pubblicazione:', dataEredirata)

      setFormData(prev => ({
        ...prev,
        bando_id: bandoId,
        titolo_progetto: `Progetto ${selectedBando.nome}`,
        contributo_ammesso: selectedBando.contributo_massimo,
        percentuale_contributo: selectedBando.percentuale_contributo,
        // Eredita la data pubblicazione graduatoria dal bando
        data_pubblicazione_graduatoria: dataEredirata
      }))
    }
  }

  const handleImportoChange = (importo: number) => {
    const contributo = Math.round(importo * (formData.percentuale_contributo / 100))
    setFormData(prev => ({
      ...prev,
      importo_totale_progetto: importo,
      contributo_ammesso: contributo
    }))
  }

  const handlePercentualeChange = (percentuale: number) => {
    const contributo = Math.round(formData.importo_totale_progetto * (percentuale / 100))
    setFormData(prev => ({
      ...prev,
      percentuale_contributo: percentuale,
      contributo_ammesso: contributo
    }))
  }

  const handleSave = async () => {
    if (!formData.bando_id || !formData.cliente_id || !formData.titolo_progetto) {
      alert('Bando, Cliente e Titolo progetto sono obbligatori')
      return
    }

    setLoading(true)
    try {
      // Prepara dati per salvataggio
      const dataToSave = { ...formData }

      // DEBUG: Verifica cosa stiamo salvando
      console.log('üîç DEBUG - Form data prima del save:', {
        data_pubblicazione_graduatoria: formData.data_pubblicazione_graduatoria,
        bando_id: formData.bando_id,
        cliente_id: formData.cliente_id,
        bandoSelezionato: bandoSelezionato?.data_pubblicazione_graduatoria,
        bando_prop: bando?.data_pubblicazione_graduatoria
      })
      console.log('üîç DEBUG - Data to save structure completa:', JSON.stringify(dataToSave, null, 2))

      // Gestisci date vuote - se non presenti, le rimuoviamo dal payload
      if (!dataToSave.data_pubblicazione_graduatoria) delete dataToSave.data_pubblicazione_graduatoria
      if (!dataToSave.data_decreto_concessione) delete dataToSave.data_decreto_concessione
      if (!dataToSave.scadenza_accettazione_esiti) delete dataToSave.scadenza_accettazione_esiti
      if (!dataToSave.data_avvio_progetto) delete dataToSave.data_avvio_progetto
      if (!dataToSave.data_fine_progetto_prevista) delete dataToSave.data_fine_progetto_prevista

      // Gestisci campi numerici
      if (!dataToSave.importo_totale_progetto) dataToSave.importo_totale_progetto = 0
      if (!dataToSave.contributo_ammesso) dataToSave.contributo_ammesso = 0
      if (!dataToSave.percentuale_contributo) dataToSave.percentuale_contributo = 0
      if (!dataToSave.percentuale_anticipo) dataToSave.percentuale_anticipo = 30

      let progettoId: string

      if (progetto?.id) {
        // Modifica progetto esistente
        console.log('Aggiornando progetto esistente con ID:', progetto.id)
        const { error: progettoError } = await supabase
          .from('scadenze_bandi_progetti')
          .update(dataToSave)
          .eq('id', progetto.id)

        if (progettoError) {
          console.error('Errore aggiornamento progetto:', progettoError)
          throw progettoError
        }
        progettoId = progetto.id
      } else {
        // Inserisci nuovo progetto
        console.log('Inserendo nuovo progetto...')
        const { data: progettoData, error: progettoError } = await supabase
          .from('scadenze_bandi_progetti')
          .insert([dataToSave])
          .select()
          .single()

        if (progettoError) {
          console.error('Errore inserimento progetto:', {
            message: progettoError.message,
            details: progettoError.details,
            hint: progettoError.hint,
            code: progettoError.code,
            dataToSave
          })
          throw progettoError
        }

        console.log('Progetto inserito con successo:', progettoData)
        progettoId = progettoData.id
      }

      // Genera scadenze automatiche dal template del bando (solo per nuovi progetti)
      if (!progetto?.id) {
        console.log('üîÑ Verifica condizioni per generazione scadenze:', {
          isNewProject: !progetto?.id,
          hasDataPubblicazione: !!formData.data_pubblicazione_graduatoria,
          dataPubblicazione: formData.data_pubblicazione_graduatoria,
          bandoId: formData.bando_id
        })

        console.log('üîç DEBUG - Controllo data per generazione scadenze:', {
          'formData.data_pubblicazione_graduatoria': formData.data_pubblicazione_graduatoria,
          'bandoSelezionato?.data_pubblicazione_graduatoria': bandoSelezionato?.data_pubblicazione_graduatoria,
          'entrambi presenti': !!(formData.data_pubblicazione_graduatoria || bandoSelezionato?.data_pubblicazione_graduatoria)
        })

        if (formData.data_pubblicazione_graduatoria || bandoSelezionato?.data_pubblicazione_graduatoria) {
          const dataToUse = formData.data_pubblicazione_graduatoria || bandoSelezionato?.data_pubblicazione_graduatoria
          console.log('‚úÖ Generando scadenze per nuovo progetto con data pubblicazione:', dataToUse)
          await generateScadenzeFromTemplate(progettoId, formData.bando_id)
        } else {
          console.log('‚ö†Ô∏è Nessuna data_pubblicazione_graduatoria trovata per generare scadenze automatiche')
        }
      } else {
        console.log('‚è∏Ô∏è Skip generazione scadenze - progetto esistente in modifica')
      }

      onProgettoCreated()
      onClose()
    } catch (error: any) {
      console.error('Errore salvataggio progetto:', error)
      alert(`Errore nel salvataggio: ${error.message || 'Errore sconosciuto'}`)
    } finally {
      setLoading(false)
    }
  }

  const generateScadenzeFromTemplate = async (progettoId: string, bandoId: string) => {
    try {
      console.log('üîÑ Generando scadenze automatiche per progetto:', progettoId, 'da bando:', bandoId)

      // Carica i template di scadenze del bando
      const { data: templates, error: templatesError } = await supabase
        .from('scadenze_bandi_template_scadenze')
        .select('*')
        .eq('bando_id', bandoId)
        .order('ordine_sequenza')

      if (templatesError) {
        console.error('‚ùå Errore caricamento template nella generateScadenzeFromTemplate:', templatesError)
        throw templatesError
      }

      console.log('üìã Template trovati per generazione scadenze:', templates?.length || 0)
      console.log('üìã Template dettaglio:', templates)

      if (!templates || templates.length === 0) {
        console.log('‚ö†Ô∏è Nessun template di scadenze trovato per il bando:', bandoId)
        return
      }

      // Carica le informazioni del bando
      const { data: bandoData, error: bandoError } = await supabase
        .from('scadenze_bandi_bandi')
        .select('data_pubblicazione_graduatoria, nome')
        .eq('id', bandoId)
        .single()

      if (bandoError) throw bandoError

      // Debug delle date disponibili
      console.log('üîç Debug date disponibili:')
      console.log('  - formData.data_pubblicazione_graduatoria:', formData.data_pubblicazione_graduatoria)
      console.log('  - bandoData.data_pubblicazione_graduatoria:', bandoData?.data_pubblicazione_graduatoria)
      console.log('  - bandoData completo:', bandoData)

      // Usa i template del bando se disponibili
      if (templates && templates.length > 0) {
        console.log(`üìã Usando ${templates.length} template del bando per generare scadenze`)
        const scadenzeToInsert = []

        for (const template of templates) {
          console.log('üîÑ Processando template:', template)
          let dataScadenza = null

          // Calcola la data in base all'evento di riferimento del template
          let dataRiferimento = null

          // Determina la data di riferimento in base al tipo di evento
          if (template.evento_riferimento === 'pubblicazione_graduatoria') {
            dataRiferimento = formData.data_pubblicazione_graduatoria || bandoData?.data_pubblicazione_graduatoria
          } else if (template.evento_riferimento === 'decreto_concessione') {
            dataRiferimento = formData.data_decreto_concessione
          } else if (template.evento_riferimento === 'avvio_progetto') {
            dataRiferimento = formData.data_avvio_progetto
          }

          // Se non abbiamo trovato una data specifica, usa data_pubblicazione_graduatoria come fallback
          if (!dataRiferimento) {
            console.log(`‚ö†Ô∏è Evento "${template.evento_riferimento}" non disponibile per template "${template.nome}", uso data_pubblicazione_graduatoria come fallback`)
            dataRiferimento = formData.data_pubblicazione_graduatoria || bandoData?.data_pubblicazione_graduatoria
          }

          if (dataRiferimento) {
            const dataRif = new Date(dataRiferimento)
            console.log('üìÖ Data di riferimento trovata:', dataRif, 'per template:', template.nome)

            dataScadenza = new Date(dataRif)
            // Usa giorni_da_evento dalla struttura reale del template
            dataScadenza.setDate(dataScadenza.getDate() + (template.giorni_da_evento || 0))
            console.log('üìÖ Scadenza calcolata:', dataScadenza.toISOString().split('T')[0])
          } else {
            console.log(`‚ö†Ô∏è Nessuna data di riferimento disponibile per template "${template.nome}"`)
          }

          // Se abbiamo una data calcolata, aggiungi la scadenza
          if (dataScadenza) {
            scadenzeToInsert.push({
              progetto_id: progettoId,
              bando_id: bandoId,
              cliente_id: formData.cliente_id,
              titolo: template.nome || template.nome_scadenza,
              data_scadenza: dataScadenza.toISOString().split('T')[0],
              stato: 'non_iniziata',
              priorita: template.priorita || 'media',
              responsabile_email: template.responsabile || 'amministrativo@blm.it',
              note: `${template.descrizione} - Generata automaticamente da template`,
              giorni_preavviso: [30, 15, 7, 1]
            })
            console.log(`‚úÖ Scadenza "${template.nome || template.nome_scadenza}" calcolata per: ${dataScadenza.toISOString().split('T')[0]}`)
          } else {
            console.log(`‚ö†Ô∏è Impossibile calcolare scadenza "${template.nome || template.nome_scadenza}" - data di riferimento mancante per evento: ${template.evento_riferimento}`)
          }
        }

        // Inserisci le scadenze generate
        if (scadenzeToInsert.length > 0) {
          console.log('üìù Inserendo scadenze:', JSON.stringify(scadenzeToInsert, null, 2))

          const { error: insertError } = await supabase
            .from('scadenze_bandi_scadenze')
            .insert(scadenzeToInsert)

          if (insertError) {
            console.error('‚ùå Errore specifico inserimento scadenze:', insertError)
            throw insertError
          }
          console.log(`‚úÖ Generate ${scadenzeToInsert.length} scadenze automatiche per progetto ${progettoId}`)
        } else {
          console.log('‚ö†Ô∏è Nessuna scadenza da inserire (nessun template applicabile con dati disponibili)')
        }
      } else {
        console.log('‚ö†Ô∏è Nessun template di scadenze configurato per questo bando')
      }
    } catch (error) {
      console.error('‚ùå Errore generazione scadenze:', error)
      console.error('‚ùå Dettagli errore:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code,
        fullError: error
      })
      // Non bloccare il salvataggio del progetto se le scadenze falliscono
    }
  }

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('it-IT', {
      style: 'currency',
      currency: 'EUR',
      maximumFractionDigits: 0
    }).format(amount)
  }

  // Funzioni per gestione documenti
  const loadDocumenti = async (progettoId: string) => {
    try {
      const { data, error } = await supabase
        .from('scadenze_bandi_documenti_progetto_view')
        .select('*')
        .eq('progetto_id', progettoId)
        .order('created_at', { ascending: false })

      if (error) throw error

      // Separa documenti ereditati da documenti propri
      const ereditati = data?.filter(doc => doc.categoria === 'ereditato') || []
      const propri = data?.filter(doc => doc.categoria !== 'ereditato') || []

      setDocumentiEreditati(ereditati)
      setDocumenti(propri)
    } catch (error) {
      console.error('Errore caricamento documenti progetto:', error)
    }
  }

  const handleFileUpload = async (files: FileList, categoria: 'proprio' | 'compilato' = 'proprio') => {
    if (!files.length || !progetto?.id) {
      alert('Salva prima il progetto, poi potrai caricare i documenti')
      return
    }

    setUploading(true)

    for (let i = 0; i < files.length; i++) {
      const file = files[i]
      const fileName = file.name
      const fileKey = `${Date.now()}-${fileName}`

      try {
        setUploadProgress(prev => ({ ...prev, [fileName]: 0 }))

        // Upload file to Supabase Storage
        const filePath = `${progetto.id}/${fileKey}`

        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('progetti-documenti')
          .upload(filePath, file)

        if (uploadError) throw uploadError

        setUploadProgress(prev => ({ ...prev, [fileName]: 50 }))

        // Determina tipo documento dal nome file
        let tipoDocumento = 'documento_generico'
        if (fileName.toLowerCase().includes('decreto')) tipoDocumento = 'decreto_concessione'
        else if (fileName.toLowerCase().includes('sal')) tipoDocumento = 'sal'
        else if (fileName.toLowerCase().includes('rendicont')) tipoDocumento = 'rendicontazione'
        else if (fileName.toLowerCase().includes('accettaz')) tipoDocumento = 'accettazione_esiti'

        // Salva record nel database
        const { data: docData, error: docError } = await supabase
          .from('scadenze_bandi_documenti_progetto')
          .insert({
            progetto_id: progetto.id,
            nome_file: fileName,
            nome_originale: fileName,
            tipo_documento: tipoDocumento,
            categoria: categoria,
            formato_file: file.type,
            dimensione_bytes: file.size,
            url_file: filePath,
            descrizione: `Documento caricato il ${new Date().toLocaleDateString('it-IT')}`,
            caricato_da: 'UTENTE'
          })
          .select()
          .single()

        if (docError) throw docError

        setUploadProgress(prev => ({ ...prev, [fileName]: 100 }))

        // Aggiorna lista documenti
        setDocumenti(prev => [docData, ...prev])

      } catch (error: any) {
        console.error('Errore upload documento progetto:', error)
        alert(`Errore caricando ${fileName}: ${error.message || 'Errore sconosciuto'}`)
      }
    }

    setUploading(false)
    setUploadProgress({})
  }

  const autoCompileDocument = async (documentId: string) => {
    if (!progetto?.id) return

    try {
      setUploading(true)

      console.log('üöÄ Avvio autocompilazione con nuovo sistema template-based')

      // STEP 1: Verifica se esiste template per il bando
      const templateKey = `template_${formData.bando_id}`
      const templateData = localStorage.getItem(templateKey)

      if (!templateData) {
        alert('Nessun template trovato per questo bando. Configura prima i template nella sezione BANDI ‚Üí Template Documenti.')
        return
      }

      const parsedTemplate = JSON.parse(templateData)
      console.log('üìÑ Template trovato:', parsedTemplate.file_name)

      // STEP 2: Carica dati completi del cliente
      const { data: clienteCompleto, error: clienteError } = await supabase
        .from('scadenze_bandi_clienti')
        .select('*')
        .eq('id', formData.cliente_id)
        .single()

      if (clienteError) throw clienteError

      console.log('üë§ Dati cliente caricati:', clienteCompleto.denominazione)

      // STEP 3: Prepara dati progetto
      const progettoData = { ...formData }

      // STEP 4: Chiama API di compilazione template
      console.log('‚öôÔ∏è Chiamata API compilazione template...')

      const compileResponse = await fetch('/api/compile-template', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          templateData: parsedTemplate,
          clientData: clienteCompleto,
          projettoData: progettoData
        })
      })

      const compileResult = await compileResponse.json()

      if (!compileResult.success) {
        throw new Error(compileResult.error || 'Errore compilazione template')
      }

      console.log('‚úÖ Template compilato con successo!')
      console.log(`üìä Sostituzioni effettuate: ${compileResult.replacements_made}`)

      if (compileResult.remaining_placeholders?.length > 0) {
        console.log('‚ö†Ô∏è Placeholder non sostituiti:', compileResult.remaining_placeholders)
      }

      // STEP 5: Converti HTML compilato in documento Word
      console.log('üìù Conversione HTML ‚Üí Word...')

      // Per ora creiamo un documento Word semplice con il contenuto HTML
      // Questo pu√≤ essere migliorato usando librerie pi√π avanzate
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Documento Compilato</title>
            <style>
                body { font-family: Times New Roman, serif; font-size: 12pt; line-height: 1.5; }
                .placeholder-tag { background-color: #e3f2fd; border: 1px solid #2196f3; padding: 2px 4px; }
            </style>
        </head>
        <body>
            ${compileResult.compiled_html}
        </body>
        </html>
      `

      // Crea file HTML temporaneo per download
      const htmlBlob = new Blob([htmlContent], {
        type: 'text/html;charset=utf-8'
      })

      // STEP 6: Carica il documento compilato su storage

      const timestamp = new Date().toISOString().replace(/[:.]/g, '-')
      const fileName = `COMPILATO_${parsedTemplate.file_name}_${timestamp}.html`

      console.log('üì§ Upload documento compilato...')

      const { error: uploadError } = await supabase.storage
        .from('progetti-documenti')
        .upload(`${progetto.id}/${fileName}`, htmlBlob, {
          contentType: 'text/html;charset=utf-8',
          cacheControl: '3600',
          upsert: true
        })

      if (uploadError) {
        throw new Error(`Errore upload: ${uploadError.message}`)
      }

      console.log('‚úÖ Documento caricato con successo!')

      // STEP 7: Aggiorna database con il nuovo documento
      const { data: docData, error: docError } = await supabase
        .from('scadenze_bandi_documenti_progetto')
        .insert([{
          progetto_id: progetto.id,
          nome_file: fileName,
          nome_originale: fileName,
          tipo_documento: 'documento_compilato',
          categoria: 'compilato',
          formato_file: 'text/html',
          dimensione_bytes: htmlBlob.size,
          url_file: `${progetto.id}/${fileName}`,
          descrizione: `Documento compilato automaticamente da template: ${parsedTemplate.file_name}`,
          caricato_da: 'SISTEMA_AUTOCOMPILAZIONE',
          auto_compilazione_completata: true,
          auto_compilazione_status: `‚úÖ Compilato con ${compileResult.replacements_made} sostituzioni`
        }])
        .select()
        .single()

      if (docError) throw docError

      console.log('‚úÖ Database aggiornato con nuovo documento')

      // STEP 8: Ricarica documenti per mostrare il nuovo file
      await loadDocumenti(progetto.id)

      // STEP 9: Notifica utente
      alert(`üéâ Template compilato con successo!

üìÑ File: ${fileName}
üìä Sostituzioni: ${compileResult.replacements_made}
${compileResult.remaining_placeholders?.length > 0 ?
  `‚ö†Ô∏è Placeholder non sostituiti: ${compileResult.remaining_placeholders.join(', ')}` :
  '‚úÖ Tutti i placeholder sostituiti'}

Il documento compilato √® disponibile nella sezione documenti.`)

    } catch (error: any) {
      console.error('‚ùå Errore autocompilazione template:', error)
      alert(`‚ùå Errore: ${error.message}`)
    } finally {
      setUploading(false)
    }
  }

  const deleteDocument = async (docId: string, urlFile: string) => {
    try {
      // Rimuovi da storage
      const { error: storageError } = await supabase.storage
        .from('progetti-documenti')
        .remove([urlFile])

      if (storageError) throw storageError

      // Rimuovi dal database
      const { error: dbError } = await supabase
        .from('scadenze_bandi_documenti_progetto')
        .delete()
        .eq('id', docId)

      if (dbError) throw dbError

      // Aggiorna lista
      setDocumenti(prev => prev.filter(doc => doc.id !== docId))
    } catch (error: any) {
      console.error('Errore eliminazione documento:', error)
      alert(`Errore eliminando documento: ${error.message}`)
    }
  }
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-6xl w-full h-full max-h-[95vh] flex flex-col overflow-hidden">
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-gray-200">
          <div>
            <h2 className="text-2xl font-bold text-gray-900">
              {progetto ? 'Modifica Progetto' : 'Nuovo Progetto'}
            </h2>
            <p className="text-gray-600">
              {bando ? `Progetto per: ${bando.titolo}` : 'Compila i dettagli del progetto'}
            </p>
          </div>
          <button
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-4 space-y-6">
          console.log('üîç Invocando AI per analisi documento...')
          console.log('üìä Dati aziendali inviati all\'AI:', data.placeholders)

          const aiAnalysisResponse = await fetch('/api/analyze-document', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              documentText: documentText.value,
              companyData: data.placeholders
            })
          })

          if (!aiAnalysisResponse.ok) {
            const errorData = await aiAnalysisResponse.json()
            throw new Error(`AI Analysis failed: ${errorData.error || 'Unknown error'}`)
          }

          const aiResult = await aiAnalysisResponse.json()

          if (!aiResult.success) {
            throw new Error(`AI Analysis failed: ${aiResult.error}`)
          }

          console.log('üéØ Sostituzioni AI ricevute:', aiResult.analysis.replacements ? aiResult.analysis.replacements.length : 0)
          console.log('üìã Note compilazione:', aiResult.analysis.compilation_notes)

          // APPROCCIO IBRIDO: Usiamo le sostituzioni intelligenti dell'AI
          console.log('üìù Applicando sostituzioni intelligenti AI...')

          const replacements = aiResult.analysis.replacements

          if (!replacements || !Array.isArray(replacements)) {
            throw new Error('AI non ha restituito le sostituzioni nel formato corretto')
          }

          try {
            // APPROCCIO IBRIDO: Usiamo le sostituzioni intelligenti dell'AI sul documento originale
            console.log('üìÑ Applicando sostituzioni AI sul documento originale...')

            const arrayBuffer = await templateBlob.arrayBuffer()
            const zip = new PizZip(arrayBuffer)

            // Modifica solo il file document.xml principale
            if (zip.files['word/document.xml']) {
              let xmlContent = zip.files['word/document.xml'].asText()

              console.log('üìÑ XML content originale length:', xmlContent.length)
              console.log('üîß Sostituzioni da applicare:', replacements.length)

              // Applica le sostituzioni intelligenti dell'AI
              replacements.forEach((replacement: any, index: number) => {
                const { search, replace } = replacement

                console.log(`üîÑ Sostituzione ${index + 1}: "${search}" ‚Üí "${replace}"`)

                if (!search || replace === undefined) {
                  console.log(`‚ö†Ô∏è Pattern o sostituzione non valida, salto...`)
                  return
                }

                // Sostituzione semplice e diretta
                if (xmlContent.includes(search)) {
                  // Sostituisci solo la prima occorrenza
                  const firstIndex = xmlContent.indexOf(search)
                  xmlContent = xmlContent.substring(0, firstIndex) +
                             replace +
                             xmlContent.substring(firstIndex + search.length)
                  console.log(`‚úÖ Sostituito: "${search}"`)
                } else {
                  console.log(`‚ö†Ô∏è Pattern non trovato: "${search}"`)

                  // Prova con pattern frammentati per XML
                  const searchWords = search.split(' ').filter(w => w.length > 2)
                  if (searchWords.length > 1 && searchWords.every(word => xmlContent.includes(word))) {
                    // Pattern flessibile per testi frammentati
                    const flexPattern = searchWords.map(word =>
                      word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                    ).join('(?:<[^>]*>|\\s)*')

                    const flexRegex = new RegExp(flexPattern, 'i')
                    if (flexRegex.test(xmlContent)) {
                      xmlContent = xmlContent.replace(flexRegex, replace)
                      console.log(`‚úÖ Sostituito con pattern frammentato: "${search}"`)
                    }
                  }
                }
              })

              console.log('‚úÖ Sostituzioni AI applicate!')

              // Salva il XML modificato
              zip.file('word/document.xml', xmlContent)
              console.log('‚úÖ XML document.xml aggiornato')
            }

            // Genera il documento Word modificato
            const compiledBuffer = zip.generate({
              type: 'arraybuffer',
              compression: 'DEFLATE',
            })

            compiledBlob = new Blob([compiledBuffer], {
              type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            })

            console.log('‚úÖ Documento Word modificato con successo!')

          } catch (docxError: any) {
            console.warn('‚ö†Ô∏è Modifica documento Word fallita, creando report:', docxError)

            // Fallback: crea un report dettagliato
            const reportContent = `ANALISI INTELLIGENTE DOCUMENTO
==================================

STRATEGIA DI COMPILAZIONE:
${aiResult.analysis.compilation_strategy}

SOSTITUZIONI IDENTIFICATE:
${replacements.map((repl: any, index: number) => `
${index + 1}. CERCA: "${repl.search_pattern}"
   SOSTITUISCI CON: "${repl.replace_with}"
   CONTESTO: ${repl.context}
   TIPO: ${repl.field_type}
   CONFIDENZA: ${repl.confidence}
   RAGIONAMENTO: ${repl.reasoning}
`).join('\n')}

==================================
ISTRUZIONI:
1. Apri il documento originale
2. Applica le sostituzioni sopra elencate
3. Salva il documento compilato
`

            compiledBlob = new Blob([reportContent], {
              type: 'text/plain;charset=utf-8'
            })

            console.log('‚úÖ Report sostituzioni AI generato!')
          }

        } catch (aiError: any) {
          console.error('‚ùå Errore compilazione AI:', aiError)

          // Fallback: Preserva il documento originale e crea report di errore
          console.log('üîÑ Fallback: creando report di errore AI...')

          const errorReport = `ERRORE ANALISI AI - DOCUMENTO PRESERVATO
========================================

DOCUMENTO ORIGINALE: ${data.upload_target.filename.replace('COMPILATO_', '')}
DATA TENTATIVO: ${new Date().toLocaleString('it-IT')}

ERRORE AI:
${aiError.message}

DETTAGLI:
${aiError.toString()}

DATI AZIENDALI DISPONIBILI:
${Object.entries(data.placeholders).map(([key, value]) => `${key}: ${value}`).join('\n')}

========================================
AZIONI SUGGERITE:
1. Verifica la connessione internet
2. Controlla che la API key OpenAI sia valida
3. Riprova l'operazione
4. Se il problema persiste, compila manualmente il documento

Il documento originale √® disponibile nella sezione documenti ereditati.
`

          compiledBlob = new Blob([errorReport], {
            type: 'text/plain;charset=utf-8'
          })

          console.log('‚úÖ Report di errore creato - documento originale preservato')
        }

      } else if (isTextFile) {
        // STEP 4b: File di testo - compilazione con regex
        let templateContent = await templateBlob.text()
        let compiledContent = templateContent

        const placeholders = data.placeholders
        Object.keys(placeholders).forEach(placeholder => {
          const value = placeholders[placeholder] || '[NON_DISPONIBILE]'
          const regex = new RegExp(`\\{\\{${placeholder}\\}\\}`, 'g')
          compiledContent = compiledContent.replace(regex, value)
        })

        compiledBlob = new Blob([compiledContent], { type: templateBlob.type })

      } else {
        // STEP 4c: Altri file binari - file di istruzioni
        const placeholders = data.placeholders
        const compilationInfo = `DATI PER COMPILAZIONE MANUALE
=================================

File originale: ${data.upload_target.filename.replace('COMPILATO_', '')}
Data compilazione: ${new Date().toLocaleString('it-IT')}

PLACEHOLDER DA SOSTITUIRE:
${Object.keys(placeholders).map(key => `{{${key}}} ‚Üí ${placeholders[key]}`).join('\n')}

=================================
ISTRUZIONI:
1. Scarica il template originale
2. Apri il file con l'editor appropriato
3. Sostituisci manualmente i placeholder sopra
4. Salva il file compilato

Template originale disponibile nella sezione documenti ereditati.
`

        compiledBlob = new Blob([compilationInfo], { type: 'text/plain' })
      }

      // STEP 5: Carica file compilato nel bucket progetti
      let uploadPath: string
      let contentType: string

      if (isWordFile && compiledBlob.type.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document')) {
        // File Word compilato normalmente
        uploadPath = data.upload_target.path
        contentType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      } else if (isWordFile && compiledBlob.type.includes('text/plain')) {
        // Report AI generato per Word
        uploadPath = data.upload_target.path.replace('.docx', '_ANALISI_AI.txt').replace('.pdf', '_ANALISI_AI.txt')
        contentType = 'text/plain;charset=utf-8'
      } else if (isTextFile) {
        uploadPath = data.upload_target.path
        contentType = templateBlob.type
      } else {
        uploadPath = data.upload_target.path.replace('.docx', '_ISTRUZIONI.txt').replace('.pdf', '_ISTRUZIONI.txt')
        contentType = 'text/plain'
      }

      console.log('üì§ Tentativo upload file compilato:', {
        bucket: data.upload_target.bucket,
        path: uploadPath,
        contentType,
        blobSize: compiledBlob.size
      })

      const { data: uploadData, error: uploadError } = await supabase.storage
        .from(data.upload_target.bucket)
        .upload(uploadPath, compiledBlob, {
          contentType,
          upsert: true
        })

      console.log('üì§ Risultato upload:', { uploadData, uploadError })

      if (uploadError) {
        console.error('‚ùå Errore upload completo:', uploadError)
        throw new Error(`Errore upload file compilato: ${JSON.stringify(uploadError)}`)
      }

      if (!uploadData) {
        throw new Error('Upload completato ma nessun data ricevuto')
      }

      console.log('‚úÖ Upload completato con successo:', uploadData)

      // STEP 6: Aggiorna il database con il path del file compilato
      console.log('üîÑ Aggiornando database con path file compilato...')

      // Determina il nome file corretto basato sul tipo di output
      let finalFileName = data.upload_target.filename
      if (isWordFile && compiledBlob.type.includes('text/plain')) {
        // √à un report AI, aggiorna il nome per riflettere questo
        finalFileName = data.upload_target.filename.replace('.docx', '_ANALISI_AI.txt')
      }

      const { error: updateError } = await supabase
        .from('scadenze_bandi_documenti_progetto')
        .update({
          url_file: uploadPath,
          nome_file: finalFileName,
          auto_compilazione_completata: true,
          auto_compilazione_status: `‚úÖ Compilato e caricato con successo: ${finalFileName}`,
          updated_at: new Date().toISOString()
        })
        .eq('id', documentId)

      if (updateError) {
        console.error('‚ö†Ô∏è Errore aggiornamento database:', updateError)
        // Non blocchiamo l'operazione per questo errore
      } else {
        console.log('‚úÖ Database aggiornato con path compilato')
      }

      // STEP 7: Ricarica documenti per vedere il nuovo file
      await loadDocumenti(progetto.id)

      if (isWordFile) {
        alert(`üéâ Documento Word compilato automaticamente con VERA sostituzione dei placeholder! Salvato come: ${data.upload_target.filename}`)
      } else if (isTextFile) {
        alert(`‚úÖ Documento di testo compilato automaticamente e salvato come: ${data.upload_target.filename}`)
      } else {
        alert(`‚úÖ File di istruzioni creato per la compilazione manuale. Scarica il file di istruzioni per vedere i dati da inserire.`)
      }

    } catch (error: any) {
      console.error('Errore auto-compilazione:', error)
      alert(`‚ùå Errore auto-compilazione: ${error.message}`)
    } finally {
      setUploading(false)
    }
  }

  const deleteDocument = async (docId: string, urlFile: string) => {
    try {
      // Rimuovi da storage
      const { error: storageError } = await supabase.storage
        .from('progetti-documenti')
        .remove([urlFile])

      if (storageError) throw storageError

      // Rimuovi dal database
      const { error: dbError } = await supabase
        .from('scadenze_bandi_documenti_progetto')
        .delete()
        .eq('id', docId)

      if (dbError) throw dbError

      // Aggiorna lista
      setDocumenti(prev => prev.filter(doc => doc.id !== docId))
    } catch (error: any) {
      console.error('Errore eliminazione documento:', error)
      alert(`Errore eliminando documento: ${error.message}`)
    }
  }

  const downloadDocument = async (urlFile: string, fileName: string) => {
    try {
      console.log('üîç Tentativo download documento con signed URL:', {
        bucket: 'progetti-documenti',
        path: urlFile,
        fileName
      })

      // Prova prima con signed URL (pi√π affidabile)
      const { data: signedUrlData, error: signedUrlError } = await supabase.storage
        .from('progetti-documenti')
        .createSignedUrl(urlFile, 60) // 60 secondi di validit√†

      if (signedUrlError) {
        console.warn('‚ö†Ô∏è Signed URL fallita, provo download diretto:', signedUrlError)

        // Fallback a download diretto
        const { data, error } = await supabase.storage
          .from('progetti-documenti')
          .download(urlFile)

        if (error) throw error
        if (!data) throw new Error('Nessun dato ricevuto dal download')

        // Crea URL temporaneo per download
        const url = URL.createObjectURL(data)
        const a = document.createElement('a')
        a.href = url
        a.download = fileName
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)

      } else {
        console.log('‚úÖ Signed URL creata:', signedUrlData.signedUrl)

        // Download tramite signed URL
        const response = await fetch(signedUrlData.signedUrl)

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }

        const blob = await response.blob()

        // Crea URL temporaneo per download
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = fileName
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
      }

      console.log('‚úÖ Download completato con successo')
    } catch (error: any) {
      console.error('Errore download documento:', error)
      alert(`Errore scaricando documento: ${error.message || 'Errore sconosciuto'}`)
    }
  }

  const tabs = [
    { id: 'generale', label: 'Dati Generali', icon: Building2 },
    { id: 'importi', label: 'Importi', icon: Euro },
    { id: 'scadenze', label: 'Date e Scadenze', icon: Calendar },
    { id: 'documenti', label: 'Documenti', icon: Upload },
    { id: 'avanzate', label: 'Opzioni Avanzate', icon: FileText }
  ]

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-6xl w-full h-full max-h-[95vh] flex flex-col overflow-hidden">
        {/* Header */}
        <div className="flex justify-between items-center p-6 border-b">
          <div>
            <h2 className="text-2xl font-bold text-gray-900">
              {progetto ? 'Modifica Progetto' : 'Nuovo Progetto'}
            </h2>
            <p className="text-gray-600">
              {progetto
                ? 'Modifica i dati del progetto esistente'
                : 'Crea un progetto da un bando vinto con scadenze automatiche'
              }
            </p>
          </div>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Tabs */}
        <div className="border-b">
          <div className="flex">
            {tabs.map((tab) => {
              const Icon = tab.icon
              return (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as TabType)}
                  className={`px-6 py-3 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${
                    activeTab === tab.id
                      ? 'border-blue-500 text-primary-600 bg-blue-50'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  <Icon className="w-4 h-4" />
                  {tab.label}
                </button>
              )
            })}
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 p-6 overflow-y-auto">
          {/* Tab Generale */}
          {activeTab === 'generale' && (
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Collegamento Bando */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Bando di Origine *
                  </label>
                  <select
                    value={formData.bando_id}
                    onChange={(e) => handleBandoChange(e.target.value)}
                    disabled={!!bando}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100"
                  >
                    <option value="">Seleziona bando</option>
                    {bandi.map(b => (
                      <option key={b.id} value={b.id}>
                        {b.codice_bando} - {b.nome}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Collegamento Cliente */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Cliente/Azienda *
                  </label>
                  <select
                    value={formData.cliente_id}
                    onChange={(e) => setFormData({...formData, cliente_id: e.target.value})}
                    disabled={!!cliente}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 disabled:bg-gray-100"
                  >
                    <option value="">Seleziona cliente</option>
                    {clienti.map(c => (
                      <option key={c.id} value={c.id}>
                        {c.denominazione} - {c.partita_iva}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Codice Progetto *
                  </label>
                  {progetto ? (
                    <div className="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-700">
                      {formData.codice_progetto}
                    </div>
                  ) : (
                    <input
                      type="text"
                      value={formData.codice_progetto}
                      onChange={(e) => setFormData({...formData, codice_progetto: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                      placeholder="PRJ-2024-001"
                    />
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Stato Progetto
                  </label>
                  <select
                    value={formData.stato}
                    onChange={(e) => setFormData({...formData, stato: e.target.value as any})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                  >
                    <option value="DECRETO_ATTESO">Decreto Atteso</option>
                    <option value="DECRETO_RICEVUTO">Decreto Ricevuto</option>
                    <option value="ACCETTATO">Accettato</option>
                    <option value="IN_CORSO">In Corso</option>
                    <option value="COMPLETATO">Completato</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Titolo Progetto *
                </label>
                <input
                  type="text"
                  value={formData.titolo_progetto}
                  onChange={(e) => setFormData({...formData, titolo_progetto: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                  placeholder="Progetto Innovazione Digitale 2024"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Descrizione Progetto
                </label>
                <textarea
                  value={formData.descrizione_progetto}
                  onChange={(e) => setFormData({...formData, descrizione_progetto: e.target.value})}
                  rows={4}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                  placeholder="Descrizione dettagliata degli obiettivi e attivit√† del progetto..."
                />
              </div>
            </div>
          )}

          {/* Tab Importi */}
          {activeTab === 'importi' && (
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Importo Totale Progetto (‚Ç¨)
                  </label>
                  <input
                    type="number"
                    value={formData.importo_totale_progetto}
                    onChange={(e) => handleImportoChange(Number(e.target.value))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                    placeholder="100000"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    % Contributo
                  </label>
                  <input
                    type="number"
                    min="0"
                    max="100"
                    value={formData.percentuale_contributo}
                    onChange={(e) => handlePercentualeChange(Number(e.target.value))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                    placeholder="50"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Contributo Ammesso (‚Ç¨)
                  </label>
                  <input
                    type="number"
                    value={formData.contributo_ammesso}
                    onChange={(e) => setFormData({...formData, contributo_ammesso: Number(e.target.value)})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 bg-gray-50"
                    readOnly
                  />
                </div>
              </div>

              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="text-lg font-medium text-primary-900 mb-2">Riepilogo Economico</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                  <div>
                    <span className="text-blue-700">Investimento Totale:</span>
                    <div className="font-bold text-lg">{formatCurrency(formData.importo_totale_progetto)}</div>
                  </div>
                  <div>
                    <span className="text-blue-700">Contributo ({formData.percentuale_contributo}%):</span>
                    <div className="font-bold text-lg text-green-600">{formatCurrency(formData.contributo_ammesso)}</div>
                  </div>
                  <div>
                    <span className="text-blue-700">Co-investimento:</span>
                    <div className="font-bold text-lg">{formatCurrency(formData.importo_totale_progetto - formData.contributo_ammesso)}</div>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold text-gray-900">Gestione Anticipo</h3>

                  <div className="flex items-center gap-3">
                    <input
                      type="checkbox"
                      checked={formData.anticipo_richiedibile}
                      onChange={(e) => setFormData({...formData, anticipo_richiedibile: e.target.checked})}
                      className="rounded border-gray-300"
                    />
                    <label className="text-sm text-gray-700">Anticipo richiedibile</label>
                  </div>

                  {formData.anticipo_richiedibile && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        % Anticipo
                      </label>
                      <input
                        type="number"
                        min="0"
                        max="50"
                        value={formData.percentuale_anticipo}
                        onChange={(e) => setFormData({...formData, percentuale_anticipo: Number(e.target.value)})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        Anticipo: {formatCurrency((formData.contributo_ammesso * formData.percentuale_anticipo) / 100)}
                      </p>
                    </div>
                  )}
                </div>

                <div className="space-y-4">
                  <h3 className="text-lg font-semibold text-gray-900">Gestione SAL</h3>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Numero SAL
                    </label>
                    <select
                      value={formData.numero_sal}
                      onChange={(e) => setFormData({...formData, numero_sal: e.target.value as any})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                    >
                      <option value="UNICO">Unico (100%)</option>
                      <option value="DUE">Due SAL (50% + 50%)</option>
                      <option value="TRE">Tre SAL (30% + 40% + 30%)</option>
                    </select>
                  </div>

                  <div className="flex items-center gap-3">
                    <input
                      type="checkbox"
                      checked={formData.proroga_richiedibile}
                      onChange={(e) => setFormData({...formData, proroga_richiedibile: e.target.checked})}
                      className="rounded border-gray-300"
                    />
                    <label className="text-sm text-gray-700">Proroga richiedibile</label>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Tab Scadenze */}
          {activeTab === 'scadenze' && (
            <div className="space-y-6">
              <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <div className="flex items-center gap-2">
                  <AlertTriangle className="w-5 h-5 text-yellow-600" />
                  <p className="text-sm text-yellow-800">
                    <strong>Le scadenze verranno generate automaticamente</strong> basandosi sui template del bando selezionato e sulle date inserite qui sotto. I campi di data mappano gli eventi di riferimento del bando.
                  </p>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Data Pubblicazione Graduatoria
                  </label>
                  <input
                    type="date"
                    value={formData.data_pubblicazione_graduatoria}
                    onChange={(e) => setFormData({...formData, data_pubblicazione_graduatoria: e.target.value})}
                    disabled={!!bandoSelezionato?.data_pubblicazione_graduatoria}
                    className={`w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 ${
                      bandoSelezionato?.data_pubblicazione_graduatoria
                        ? 'bg-gray-100 cursor-not-allowed'
                        : ''
                    }`}
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    {bandoSelezionato?.data_pubblicazione_graduatoria
                      ? 'Importata dal bando (sola lettura)'
                      : 'Inserire data per calcolo automatico scadenze'
                    }
                  </p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Data Decreto Concessione
                  </label>
                  <input
                    type="date"
                    value={formData.data_decreto_concessione}
                    onChange={(e) => setFormData({...formData, data_decreto_concessione: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                  />
                  <p className="text-xs text-gray-500 mt-1">Base per calcolo scadenze automatiche</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Scadenza Accettazione Esiti
                  </label>
                  <input
                    type="date"
                    value={formData.scadenza_accettazione_esiti}
                    onChange={(e) => setFormData({...formData, scadenza_accettazione_esiti: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                  />
                  <p className="text-xs text-gray-500 mt-1">Evento per "Chiusura progetto"</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Data Avvio Progetto
                  </label>
                  <input
                    type="date"
                    value={formData.data_avvio_progetto}
                    onChange={(e) => setFormData({...formData, data_avvio_progetto: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Data Conclusione Progetto
                  </label>
                  <input
                    type="date"
                    value={formData.data_fine_progetto_prevista}
                    onChange={(e) => setFormData({...formData, data_fine_progetto_prevista: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                  />
                </div>
              </div>

              {/* Anteprima Scadenze Calcolate */}
              <div className="bg-primary-50 p-4 rounded-lg border border-primary-200">
                <div className="flex items-center gap-2 mb-3">
                  <CheckCircle className="w-5 h-5 text-primary-600" />
                  <h3 className="font-medium text-primary-900">Scadenze che verranno generate</h3>
                </div>

                {formData.bando_id ? (
                  <div className="space-y-3">
                    <p className="text-sm text-primary-800">
                      Basate sui template del bando <strong>{bandoSelezionato?.nome}</strong>:
                    </p>

                    {calcolaScadenzeAnteprima().length > 0 ? (
                      <div className="space-y-2">
                        {calcolaScadenzeAnteprima().map((scadenza, index) => (
                          <div key={index} className={`text-sm p-2 rounded ${scadenza.calcolabile ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                            <div className="flex justify-between items-center">
                              <span className="font-medium">
                                {scadenza.calcolabile ? '‚úÖ' : '‚è≥'} {scadenza.nome}
                              </span>
                              <span className="text-xs">
                                {scadenza.calcolabile ? (
                                  <span className="font-bold">{scadenza.dataScadenza}</span>
                                ) : (
                                  'Manca data di riferimento'
                                )}
                              </span>
                            </div>
                            <div className="text-xs opacity-75 mt-1">
                              {scadenza.giorni_da_evento} giorni da {scadenza.dataRiferimentoUsata || scadenza.evento_riferimento}
                              {scadenza.priorita === 'critica' && ' ‚Ä¢ CRITICA'}
                            </div>
                          </div>
                        ))}

                        {!bandoSelezionato?.data_pubblicazione_graduatoria && (
                          <div className="bg-yellow-100 text-yellow-800 p-2 rounded text-xs">
                            ‚ö†Ô∏è <strong>Data Pubblicazione Graduatoria mancante nel bando.</strong> Alcune scadenze non possono essere calcolate.
                          </div>
                        )}
                      </div>
                    ) : (
                      <p className="text-sm text-gray-600">Nessun template di scadenze configurato per questo bando.</p>
                    )}
                  </div>
                ) : (
                  <p className="text-sm text-gray-600">Seleziona un bando per vedere le scadenze automatiche.</p>
                )}
              </div>
            </div>
          )}

          {/* Tab Documenti */}
          {activeTab === 'documenti' && (
            <div className="space-y-6">
              {!progetto?.id ? (
                <div className="bg-amber-50 p-4 rounded-lg border border-amber-200">
                  <div className="flex items-center gap-2">
                    <AlertCircle className="w-5 h-5 text-amber-600" />
                    <p className="text-sm text-amber-800">
                      <strong>Salva prima il progetto</strong> per gestire i documenti. I documenti del bando verranno ereditati automaticamente.
                    </p>
                  </div>
                </div>
              ) : (
                <>
                  {/* Documenti Ereditati dal Bando */}
                  {documentiEreditati.length > 0 && (
                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                      <div className="flex justify-between items-center mb-4">
                        <div>
                          <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            <FileText className="w-5 h-5 text-blue-600" />
                            Allegati Ereditati dal Bando
                          </h3>
                          <p className="text-sm text-gray-600">
                            Moduli e allegati ereditati automaticamente dal bando madre
                          </p>
                        </div>
                      </div>

                      <div className="space-y-2">
                        {documentiEreditati.map((documento) => (
                          <div key={documento.id} className="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                            <div className="flex items-center space-x-3">
                              <FileText className="w-4 h-4 text-blue-500" />
                              <div>
                                <p className="text-sm font-medium text-gray-900">{documento.nome_file}</p>
                                <p className="text-xs text-gray-500">
                                  {documento.stato_display} ‚Ä¢
                                  Ereditato da: {documento.file_origine_bando} ‚Ä¢
                                  {new Date(documento.created_at).toLocaleString('it-IT')}
                                </p>
                              </div>
                              {documento.auto_compilazione_status && (
                                <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                  {documento.auto_compilazione_status}
                                </span>
                              )}
                            </div>
                            <div className="flex items-center space-x-2">
                              {!documento.auto_compilazione_completata && (
                                <button
                                  onClick={() => autoCompileDocument(documento.id)}
                                  disabled={uploading}
                                  className="p-1 text-gray-400 hover:text-blue-500 transition-colors disabled:opacity-50"
                                  title="Auto-compila con dati azienda"
                                >
                                  ü§ñ
                                </button>
                              )}
                              <button
                                onClick={() => downloadDocument(
                                  documento.auto_compilazione_completata && documento.file_path
                                    ? documento.file_path
                                    : documento.url_file,
                                  documento.auto_compilazione_completata && documento.nome_file_compilato
                                    ? documento.nome_file_compilato
                                    : documento.nome_file
                                )}
                                className="p-1 text-gray-400 hover:text-blue-500 transition-colors"
                                title={documento.auto_compilazione_completata ? "Scarica file compilato" : "Scarica"}
                              >
                                <Download className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Documenti Propri del Progetto */}
                  <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div className="flex justify-between items-center mb-4">
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                          <Upload className="w-5 h-5 text-green-600" />
                          Documenti del Progetto
                        </h3>
                        <p className="text-sm text-gray-600">
                          Decreti, SAL, rendicontazioni e altri documenti specifici del progetto
                        </p>
                      </div>
                      <label className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 cursor-pointer transition-colors">
                        <Upload className="w-4 h-4" />
                        {uploading ? 'Caricando...' : 'Carica Documento'}
                        <input
                          type="file"
                          multiple
                          accept=".pdf,.doc,.docx,.xls,.xlsx"
                          onChange={(e) => e.target.files && handleFileUpload(e.target.files, 'proprio')}
                          disabled={uploading}
                          className="hidden"
                        />
                      </label>
                    </div>

                    {/* Area Drop */}
                    <div
                      className="border-2 border-dashed border-green-300 hover:border-green-400 rounded-lg p-6 text-center transition-colors"
                      onDragOver={(e) => e.preventDefault()}
                      onDrop={(e) => {
                        e.preventDefault()
                        if (e.dataTransfer.files) {
                          handleFileUpload(e.dataTransfer.files, 'proprio')
                        }
                      }}
                    >
                      <Upload className="mx-auto h-8 w-8 text-green-400" />
                      <h4 className="mt-2 text-sm font-medium text-gray-900">
                        Trascina documenti qui
                      </h4>
                      <p className="mt-1 text-sm text-gray-500">
                        Supportati: PDF, DOC, DOCX, XLS, XLSX (max 10MB)
                      </p>
                    </div>

                    {/* Lista documenti propri */}
                    {documenti.length > 0 && (
                      <div className="space-y-2 mt-4">
                        <h4 className="text-sm font-medium text-gray-700">Documenti caricati:</h4>
                        <div className="grid gap-2">
                          {documenti.map((documento) => (
                            <div key={documento.id} className="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                              <div className="flex items-center space-x-3">
                                <Upload className="w-4 h-4 text-green-500" />
                                <div>
                                  <p className="text-sm font-medium text-gray-900">{documento.nome_file}</p>
                                  <p className="text-xs text-gray-500">
                                    {documento.tipo_documento} ‚Ä¢
                                    {documento.dimensione_bytes && `${Math.round(documento.dimensione_bytes / 1024)} KB`} ‚Ä¢
                                    {new Date(documento.created_at).toLocaleString('it-IT')}
                                  </p>
                                </div>
                              </div>
                              <div className="flex items-center space-x-2">
                                <button
                                  onClick={() => downloadDocument(documento.url_file, documento.nome_file)}
                                  className="p-1 text-gray-400 hover:text-green-500 transition-colors"
                                  title="Visualizza/Scarica"
                                >
                                  <Eye className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => {
                                    if (window.confirm(`Sei sicuro di voler eliminare "${documento.nome_file}"?`)) {
                                      deleteDocument(documento.id, documento.url_file)
                                    }
                                  }}
                                  className="p-1 text-gray-400 hover:text-red-500 transition-colors"
                                  title="Elimina"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Progress upload */}
                  {Object.keys(uploadProgress).length > 0 && (
                    <div className="space-y-2">
                      <h4 className="text-sm font-medium text-gray-700">Upload in corso:</h4>
                      {Object.entries(uploadProgress).map(([fileName, progress]) => (
                        <div key={fileName} className="bg-blue-50 p-3 rounded-lg">
                          <div className="flex justify-between text-sm mb-1">
                            <span className="font-medium">{fileName}</span>
                            <span>{progress}%</span>
                          </div>
                          <div className="w-full bg-blue-200 rounded-full h-2">
                            <div
                              className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                              style={{ width: `${progress}%` }}
                            ></div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </>
              )}
            </div>
          )}

          {/* Tab Avanzate */}
          {activeTab === 'avanzate' && (
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Referente Interno
                  </label>
                  <input
                    type="text"
                    value={formData.referente_interno}
                    onChange={(e) => setFormData({...formData, referente_interno: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                    placeholder="Nome referente progetto"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Email Referente Interno
                  </label>
                  <input
                    type="email"
                    value={formData.email_referente_interno}
                    onChange={(e) => setFormData({...formData, email_referente_interno: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                    placeholder="referente@blmproject.it"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Note Progetto
                </label>
                <textarea
                  value={formData.note_progetto}
                  onChange={(e) => setFormData({...formData, note_progetto: e.target.value})}
                  rows={4}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500"
                  placeholder="Note interne, osservazioni, specifiche particolari..."
                />
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="flex justify-between items-center p-6 border-t bg-gray-50 flex-shrink-0">
          <div className="text-sm text-gray-500">
            {formData.codice_progetto && (
              <div className="flex items-center gap-2">
                <FileText className="w-4 h-4" />
                Codice: {formData.codice_progetto}
              </div>
            )}
          </div>

          <div className="flex gap-3">
            <button
              onClick={onClose}
              className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
            >
              Annulla
            </button>
            <button
              onClick={handleSave}
              disabled={loading}
              className="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 disabled:opacity-50 flex items-center gap-2"
            >
              {loading ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                  Salvataggio...
                </>
              ) : (
                <>
                  <Save className="w-4 h-4" />
                  {progetto ? 'Aggiorna Progetto' : 'Crea Progetto'}
                </>
              )}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}